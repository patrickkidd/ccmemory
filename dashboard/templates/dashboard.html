<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ccmemory Dashboard - {{ project }}</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <style>
        .metric-card { text-align: center; }
        .metric-value { font-size: 2.5rem; font-weight: bold; }
        .metric-label { font-size: 0.9rem; }
        .context-item { margin-bottom: 1rem; padding: 1rem; border-radius: 4px; }
        .context-decision { border-left: 4px solid hsl(217, 71%, 53%); }
        .context-correction { border-left: 4px solid hsl(348, 100%, 61%); }
        .context-insight { border-left: 4px solid hsl(141, 53%, 53%); }
        .context-question { border-left: 4px solid hsl(48, 100%, 67%); }
        .context-failed { border-left: 4px solid hsl(344, 89%, 54%); }
        .console-log { height: 300px; overflow-y: auto; font-family: monospace; font-size: 0.8rem; padding: 0.5rem; }
        .filter-btn.is-active { background-color: hsl(171, 100%, 41%); border-color: transparent; color: #fff; }
        .filter-btn:not(.is-active) { opacity: 0.5; }
        .drop-zone { border: 2px dashed; cursor: pointer; }
        .drop-zone.hover { background-color: hsl(217, 71%, 90%); }
        @media (prefers-color-scheme: dark) { .drop-zone.hover { background-color: hsl(217, 50%, 20%); } }
        .hidden { display: none; }
        a.metric-card { text-decoration: none; color: inherit; display: block; transition: transform 0.1s; }
        a.metric-card:hover { transform: scale(1.02); }
        /* Graph styles */
        #cy { height: 450px; border-radius: 4px; }
        #graph-tooltip {
            display: none;
            position: fixed;
            background: rgba(0,0,0,0.85);
            color: #fff;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 12px;
            max-width: 300px;
            z-index: 1000;
            pointer-events: none;
            white-space: pre-wrap;
        }
        .graph-legend { display: inline-flex; gap: 0.75rem; flex-wrap: wrap; justify-content: center; }
        .graph-filters { display: flex; gap: 0.75rem; flex-wrap: wrap; }
        .legend-item { display: inline-flex; align-items: center; gap: 0.25rem; font-size: 0.8rem; }
        .legend-dot { display: inline-block; width: 10px; height: 10px; border-radius: 50%; }
        .legend-dot.decision { background: hsl(217, 71%, 53%); }
        .legend-dot.correction { background: hsl(348, 100%, 61%); }
        .legend-dot.exception { background: hsl(48, 100%, 67%); }
        .legend-dot.insight { background: hsl(141, 71%, 48%); }
        .legend-dot.question { background: hsl(271, 71%, 53%); }
        .legend-dot.failed { background: hsl(14, 100%, 53%); }
        .legend-dot.fact { background: hsl(198, 71%, 53%); }
        .legend-dot.session { background: hsl(0, 0%, 48%); }
        #node-detail { max-height: 200px; overflow-y: auto; display: none; }
        #node-detail.is-visible { display: block; }
        .node-detail-label { font-weight: 600; }
    </style>
    <script src="https://unpkg.com/cytoscape@3.28.1/dist/cytoscape.min.js"></script>
</head>
<body>
    <nav class="navbar is-dark">
        <div class="navbar-brand">
            <a class="navbar-item is-size-4" href="/?project={{ project }}">
                <strong>ccmemory</strong>
            </a>
            <a role="button" class="navbar-burger" data-target="navMenu">
                <span></span><span></span><span></span>
            </a>
        </div>
        <div id="navMenu" class="navbar-menu">
            <div class="navbar-start">
                <a class="navbar-item" href="/decisions?project={{ project }}">Decisions</a>
                <a class="navbar-item" href="/corrections?project={{ project }}">Corrections</a>
                <a class="navbar-item" href="/insights?project={{ project }}">Insights</a>
                <a class="navbar-item" href="/sessions?project={{ project }}">Sessions</a>
                <div class="navbar-item has-dropdown is-hoverable">
                    <a class="navbar-link">More</a>
                    <div class="navbar-dropdown">
                        <a class="navbar-item" href="/project-facts?project={{ project }}">Project Facts</a>
                        <a class="navbar-item" href="/failed-approaches?project={{ project }}">Failed Approaches</a>
                        <a class="navbar-item" href="/exceptions?project={{ project }}">Exceptions</a>
                        <a class="navbar-item" href="/questions?project={{ project }}">Questions</a>
                        <hr class="navbar-divider">
                        <a class="navbar-item" href="/retrievals?project={{ project }}">Retrievals</a>
                    </div>
                </div>
            </div>
            <div class="navbar-end">
                <div class="navbar-item">
                    <div class="select is-info">
                        <select id="project-select"></select>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <section class="section">
        <div class="container">
            <!-- Metrics Row -->
            <div class="columns is-multiline">
                <div class="column is-3">
                    <div class="box metric-card">
                        <p class="metric-value has-text-primary" id="coefficient">-</p>
                        <p class="metric-label">Cognitive Coefficient</p>
                    </div>
                </div>
                <div class="column is-3">
                    <a href="/decisions?project={{ project }}" class="box metric-card">
                        <p class="metric-value has-text-info" id="decisions">-</p>
                        <p class="metric-label">Total Decisions</p>
                    </a>
                </div>
                <div class="column is-3">
                    <a href="/corrections?project={{ project }}" class="box metric-card">
                        <p class="metric-value has-text-danger" id="corrections">-</p>
                        <p class="metric-label">Corrections</p>
                    </a>
                </div>
                <div class="column is-3">
                    <a href="/insights?project={{ project }}" class="box metric-card">
                        <p class="metric-value has-text-success" id="insights">-</p>
                        <p class="metric-label">Insights</p>
                    </a>
                </div>
            </div>

            <!-- Secondary Metrics -->
            <div class="columns is-multiline">
                <div class="column is-3">
                    <a href="/sessions?project={{ project }}" class="box metric-card">
                        <p class="metric-value has-text-grey" id="sessions">-</p>
                        <p class="metric-label">Sessions</p>
                    </a>
                </div>
                <div class="column is-3">
                    <a href="/failed-approaches?project={{ project }}" class="box metric-card">
                        <p class="metric-value has-text-warning" id="failed">-</p>
                        <p class="metric-label">Failed Approaches</p>
                    </a>
                </div>
                <div class="column is-3">
                    <a href="/project-facts?project={{ project }}" class="box metric-card">
                        <p class="metric-value has-text-link" id="project-facts">-</p>
                        <p class="metric-label">Project Facts</p>
                    </a>
                </div>
                <div class="column is-3">
                    <div class="box metric-card">
                        <p class="metric-value" id="reuse-rate">-</p>
                        <p class="metric-label">Decision Reuse Rate</p>
                    </div>
                </div>
            </div>

            <!-- Import Conversations -->
            <div class="columns">
                <div class="column is-half">
                    <div class="box">
                        <h3 class="title is-5">Import Conversations</h3>
                        <div id="drop-zone" class="notification has-text-centered drop-zone">
                            <p>Drop a .zip file here or click to upload</p>
                            <p class="is-size-7 has-text-grey">Zip your ~/.claude/projects/*/&lt;uuid&gt;.jsonl files (max 50MB)</p>
                            <input type="file" id="file-input" accept=".zip" class="hidden">
                        </div>
                        <div id="import-status" class="mt-3 hidden"></div>
                    </div>
                </div>
                <div class="column is-half">
                    <div class="box">
                        <h3 class="title is-5">Database</h3>
                        <button class="button is-danger is-outlined" onclick="clearDatabase()">
                            Clear All Data for Project
                        </button>
                        <p class="is-size-7 has-text-grey mt-2">Deletes all sessions, decisions, corrections, insights for current project</p>
                    </div>
                </div>
            </div>

            <!-- Knowledge Graph -->
            <div class="columns">
                <div class="column">
                    <div class="box">
                        <h2 class="title is-4">Knowledge Graph</h2>
                        <div id="cy"></div>
                        <div id="graph-tooltip"></div>
                        <div class="has-text-centered mt-3">
                            <div class="graph-legend" id="graph-legend"></div>
                        </div>
                        <div class="mt-3">
                            <div class="is-flex is-align-items-center is-flex-wrap-wrap" style="gap: 0.5rem;">
                                <div class="buttons are-small mb-0">
                                    <button class="button is-small" onclick="checkAllFilters()">All</button>
                                    <button class="button is-small" onclick="clearAllFilters()">None</button>
                                </div>
                                <div class="graph-filters">
                                    <label class="checkbox"><input type="checkbox" id="show-decisions" checked onchange="updateGraph()"> Decisions</label>
                                    <label class="checkbox"><input type="checkbox" id="show-corrections" checked onchange="updateGraph()"> Corrections</label>
                                    <label class="checkbox"><input type="checkbox" id="show-exceptions" onchange="updateGraph()"> Exceptions</label>
                                    <label class="checkbox"><input type="checkbox" id="show-insights" onchange="updateGraph()"> Insights</label>
                                    <label class="checkbox"><input type="checkbox" id="show-questions" onchange="updateGraph()"> Questions</label>
                                    <label class="checkbox"><input type="checkbox" id="show-failed" onchange="updateGraph()"> Failed</label>
                                    <label class="checkbox"><input type="checkbox" id="show-facts" checked onchange="updateGraph()"> Facts</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Node Detail Panel + Proactive Insights -->
            <div class="columns">
                <div class="column is-two-thirds">
                    <div class="box" id="node-detail">
                        <h3 class="title is-5" id="detail-title"></h3>
                        <div id="detail-content"></div>
                    </div>
                </div>
                <div class="column is-one-third">
                    <div class="box" id="proactive-insights">
                        <h3 class="title is-6">Proactive Insights</h3>
                        <div id="insights-content">
                            <p class="has-text-grey is-size-7">Loading...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Search -->
            <div class="columns">
                <div class="column">
                    <h2 class="title is-4">Search</h2>
                    <div class="field has-addons">
                        <div class="control is-expanded">
                            <input class="input" type="text" id="search-input" placeholder="Search decisions, corrections, insights...">
                        </div>
                        <div class="control">
                            <button class="button is-primary" onclick="doSearch()">Search</button>
                        </div>
                    </div>
                    <div id="search-results"></div>
                </div>
            </div>

            <!-- Developer Console -->
            <div class="columns">
                <div class="column">
                    <div class="box">
                        <div class="level">
                            <div class="level-left">
                                <h2 class="title is-5 mb-0">Developer Console</h2>
                            </div>
                            <div class="level-right">
                                <span class="tag is-warning mr-2" id="ws-status">Connecting...</span>
                                <div class="buttons are-small">
                                    <button class="button filter-btn is-active" data-cat="hook" onclick="toggleFilter('hook', this)">Hooks</button>
                                    <button class="button filter-btn is-active" data-cat="tool" onclick="toggleFilter('tool', this)">Tools</button>
                                    <button class="button filter-btn is-active" data-cat="neo4j" onclick="toggleFilter('neo4j', this)">Neo4j</button>
                                    <button class="button filter-btn is-active" data-cat="prompt" onclick="toggleFilter('prompt', this)">Prompts</button>
                                    <button class="button is-small" onclick="clearConsole()">Clear</button>
                                </div>
                            </div>
                        </div>
                        <div class="console-log box" id="console-log"></div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <script>
        const project = "{{ project }}";
        let cy = null;
        let graphData = { nodes: [], edges: [] };

        // Cytoscape graph initialization
        async function initGraph() {
            const types = [];
            if (document.getElementById('show-decisions').checked) types.push('Decision');
            if (document.getElementById('show-corrections').checked) types.push('Correction');
            if (document.getElementById('show-exceptions').checked) types.push('Exception');
            if (document.getElementById('show-insights').checked) types.push('Insight');
            if (document.getElementById('show-questions').checked) types.push('Question');
            if (document.getElementById('show-failed').checked) types.push('FailedApproach');
            if (document.getElementById('show-facts').checked) types.push('ProjectFact');

            const params = new URLSearchParams({ project, limit: 100 });
            types.forEach(t => params.append('types', t));

            const response = await fetch(`/api/graph?${params}`);
            graphData = await response.json();

            const elements = [
                ...graphData.nodes.map(n => ({
                    data: { id: n.id, label: n.label, type: n.type, ...n }
                })),
                ...graphData.edges.map(e => ({
                    data: { source: e.source, target: e.target, type: e.type }
                }))
            ];

            if (cy) {
                cy.destroy();
            }

            cy = cytoscape({
                container: document.getElementById('cy'),
                elements: elements,
                style: [
                    { selector: 'node', style: {
                        'label': 'data(label)',
                        'text-valign': 'bottom',
                        'text-halign': 'center',
                        'font-size': '10px',
                        'text-wrap': 'ellipsis',
                        'text-max-width': '80px',
                        'width': 30,
                        'height': 30
                    }},
                    { selector: 'node[type="Decision"]', style: {
                        'background-color': 'hsl(217, 71%, 53%)'
                    }},
                    { selector: 'node[type="Correction"]', style: {
                        'background-color': 'hsl(348, 100%, 61%)',
                        'shape': 'diamond'
                    }},
                    { selector: 'node[type="Exception"]', style: {
                        'background-color': 'hsl(48, 100%, 67%)',
                        'shape': 'triangle'
                    }},
                    { selector: 'node[type="Insight"]', style: {
                        'background-color': 'hsl(141, 71%, 48%)',
                        'shape': 'ellipse'
                    }},
                    { selector: 'node[type="Question"]', style: {
                        'background-color': 'hsl(271, 71%, 53%)',
                        'shape': 'round-pentagon'
                    }},
                    { selector: 'node[type="FailedApproach"]', style: {
                        'background-color': 'hsl(14, 100%, 53%)',
                        'shape': 'octagon'
                    }},
                    { selector: 'node[type="ProjectFact"]', style: {
                        'background-color': 'hsl(198, 71%, 53%)',
                        'shape': 'round-rectangle'
                    }},
                    { selector: 'node[type="Session"]', style: {
                        'background-color': 'hsl(0, 0%, 48%)',
                        'shape': 'rectangle',
                        'width': 20,
                        'height': 20
                    }},
                    { selector: 'edge', style: {
                        'width': 1,
                        'line-color': '#888',
                        'target-arrow-color': '#888',
                        'target-arrow-shape': 'triangle',
                        'curve-style': 'bezier',
                        'opacity': 0.6
                    }},
                    { selector: 'edge[type="CITES"]', style: {
                        'line-style': 'dashed',
                        'line-color': 'hsl(217, 71%, 53%)'
                    }},
                    { selector: 'edge[type="SUPERSEDES"]', style: {
                        'line-color': 'hsl(348, 100%, 61%)',
                        'width': 2
                    }},
                    { selector: ':selected', style: {
                        'border-width': 3,
                        'border-color': 'hsl(171, 100%, 41%)'
                    }}
                ],
                layout: {
                    name: 'cose',
                    animate: false,
                    randomize: false,
                    nodeRepulsion: 8000,
                    idealEdgeLength: 100,
                    edgeElasticity: 100
                }
            });

            cy.on('tap', 'node', function(evt) {
                const node = evt.target.data();
                showNodeDetail(node);
            });

            cy.on('tap', 'edge', function(evt) {
                const edge = evt.target.data();
                showEdgeDetail(edge);
            });

            cy.on('tap', function(evt) {
                if (evt.target === cy) {
                    document.getElementById('node-detail').classList.remove('is-visible');
                }
            });

            // Tooltip on hover
            const tooltip = document.getElementById('graph-tooltip');
            cy.on('mouseover', 'node', function(evt) {
                const node = evt.target.data();
                tooltip.textContent = node.label || node.id;
                tooltip.style.display = 'block';
                const pos = evt.renderedPosition;
                const container = document.getElementById('cy').getBoundingClientRect();
                tooltip.style.left = (container.left + pos.x + 10) + 'px';
                tooltip.style.top = (container.top + pos.y - 30) + 'px';
            });
            cy.on('mouseout', 'node', function() {
                tooltip.style.display = 'none';
            });
        }

        function showNodeDetail(node) {
            const panel = document.getElementById('node-detail');
            const title = document.getElementById('detail-title');
            const content = document.getElementById('detail-content');

            title.textContent = `${node.type}: ${node.label}`;

            let html = '';
            if (node.type === 'Decision') {
                if (node.status) html += `<p><span class="tag is-info">${node.status}</span></p>`;
                if (node.rationale) html += `<p><span class="node-detail-label">Rationale:</span> ${node.rationale}</p>`;
            } else if (node.type === 'Correction') {
                if (node.severity) html += `<p><span class="tag is-danger">${node.severity}</span></p>`;
                if (node.wrong_belief) html += `<p><span class="node-detail-label">Was:</span> ${node.wrong_belief}</p>`;
            } else if (node.type === 'Exception') {
                if (node.scope) html += `<p><span class="tag is-warning">${node.scope}</span></p>`;
                if (node.rule_broken) html += `<p><span class="node-detail-label">Rule:</span> ${node.rule_broken}</p>`;
            } else if (node.type === 'Insight') {
                if (node.category) html += `<p><span class="tag is-success">${node.category}</span></p>`;
            } else if (node.type === 'Question') {
                if (node.answer) html += `<p><span class="node-detail-label">Answer:</span> ${node.answer}</p>`;
            } else if (node.type === 'FailedApproach') {
                if (node.outcome) html += `<p><span class="node-detail-label">Outcome:</span> ${node.outcome}</p>`;
                if (node.lesson) html += `<p><span class="node-detail-label">Lesson:</span> ${node.lesson}</p>`;
            } else if (node.type === 'ProjectFact') {
                if (node.category) html += `<p><span class="tag is-link">${node.category}</span></p>`;
            }

            if (node.timestamp) {
                html += `<p class="is-size-7 has-text-grey">${new Date(node.timestamp).toLocaleString()}</p>`;
            }

            const edges = cy.edges().filter(e =>
                e.data('source') === node.id || e.data('target') === node.id
            );
            if (edges.length > 0) {
                html += `<p class="mt-2"><span class="node-detail-label">Connections:</span> ${edges.length} edges</p>`;
            }

            content.innerHTML = html;
            panel.classList.add('is-visible');
        }

        function showEdgeDetail(edge) {
            const panel = document.getElementById('node-detail');
            const title = document.getElementById('detail-title');
            const content = document.getElementById('detail-content');

            title.textContent = `Edge: ${edge.type}`;

            const sourceNode = cy.getElementById(edge.source).data();
            const targetNode = cy.getElementById(edge.target).data();

            let html = `<p><span class="node-detail-label">From:</span> ${sourceNode?.type || 'Unknown'}: ${sourceNode?.label || edge.source}</p>`;
            html += `<p><span class="node-detail-label">To:</span> ${targetNode?.type || 'Unknown'}: ${targetNode?.label || edge.target}</p>`;

            if (edge.similarity) {
                html += `<p><span class="node-detail-label">Similarity:</span> ${(edge.similarity * 100).toFixed(1)}%</p>`;
            }
            if (edge.auto !== undefined) {
                html += `<p><span class="tag is-light">${edge.auto ? 'Auto-generated' : 'Manual'}</span></p>`;
            }

            content.innerHTML = html;
            panel.classList.add('is-visible');
        }

        function updateGraph() {
            updateLegend();
            initGraph();
        }

        function updateLegend() {
            const legend = document.getElementById('graph-legend');
            const items = [
                { id: 'show-decisions', css: 'decision', label: 'Decision' },
                { id: 'show-corrections', css: 'correction', label: 'Correction' },
                { id: 'show-exceptions', css: 'exception', label: 'Exception' },
                { id: 'show-insights', css: 'insight', label: 'Insight' },
                { id: 'show-questions', css: 'question', label: 'Question' },
                { id: 'show-failed', css: 'failed', label: 'Failed' },
                { id: 'show-facts', css: 'fact', label: 'Fact' }
            ];
            const selected = items.filter(i => document.getElementById(i.id).checked);
            let html = selected
                .map(i => `<span class="legend-item"><span class="legend-dot ${i.css}"></span>${i.label}</span>`)
                .join('');
            if (selected.length > 0) {
                html += '<span class="legend-item"><span class="legend-dot session"></span>Session</span>';
            }
            legend.innerHTML = html;
        }

        function checkAllFilters() {
            document.getElementById('show-decisions').checked = true;
            document.getElementById('show-corrections').checked = true;
            document.getElementById('show-exceptions').checked = true;
            document.getElementById('show-insights').checked = true;
            document.getElementById('show-questions').checked = true;
            document.getElementById('show-failed').checked = true;
            document.getElementById('show-facts').checked = true;
            updateGraph();
        }

        function clearAllFilters() {
            document.getElementById('show-decisions').checked = false;
            document.getElementById('show-corrections').checked = false;
            document.getElementById('show-exceptions').checked = false;
            document.getElementById('show-insights').checked = false;
            document.getElementById('show-questions').checked = false;
            document.getElementById('show-failed').checked = false;
            document.getElementById('show-facts').checked = false;
            updateGraph();
        }

        async function loadProactiveInsights() {
            const container = document.getElementById('insights-content');
            try {
                const response = await fetch(`/api/insights/proactive?project=${project}`);
                const insights = await response.json();

                if (insights.length === 0) {
                    container.innerHTML = '<p class="has-text-grey is-size-7">No patterns detected yet.</p>';
                    return;
                }

                const icons = {
                    highly_cited: 'ðŸ”—',
                    exception_hotspot: 'âš ï¸',
                    correction_pattern: 'ðŸ”„'
                };

                container.innerHTML = insights.map(i => `
                    <div class="mb-2">
                        <span>${icons[i.type] || 'ðŸ’¡'}</span>
                        <span class="is-size-7">${i.message}</span>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Failed to load proactive insights:', error);
                container.innerHTML = '<p class="has-text-grey is-size-7">Failed to load insights.</p>';
            }
        }

        async function loadMetrics() {
            try {
                const response = await fetch(`/api/metrics?project=${project}`);
                const data = await response.json();

                document.getElementById('coefficient').textContent = data.cognitive_coefficient.toFixed(2) + 'x';
                document.getElementById('decisions').textContent = data.total_decisions;
                document.getElementById('corrections').textContent = data.total_corrections;
                document.getElementById('insights').textContent = data.total_insights;
                document.getElementById('sessions').textContent = data.total_sessions;
                document.getElementById('failed').textContent = data.total_failed_approaches;
                document.getElementById('project-facts').textContent = data.total_project_facts;
                document.getElementById('reuse-rate').textContent = (data.decision_reuse_rate * 100).toFixed(1) + '%';
            } catch (error) {
                console.error('Failed to load metrics:', error);
            }
        }

        function formatSearchItem(item, category) {
            if (category === 'decisions') {
                let content = `<strong>${item.description || 'No description'}</strong>`;
                if (item.rationale) content += `<br><small class="has-text-grey">Rationale: ${item.rationale}</small>`;
                if (item.status) content += `<br><span class="tag is-light">${item.status}</span>`;
                return content;
            } else if (category === 'corrections') {
                let content = `<strong>${item.right_belief || 'No belief'}</strong>`;
                if (item.wrong_belief) content += `<br><small class="has-text-grey">Was: ${item.wrong_belief}</small>`;
                return content;
            } else if (category === 'insights') {
                let content = `<strong>${item.summary || 'No summary'}</strong>`;
                if (item.category) content += `<br><span class="tag is-light">${item.category}</span>`;
                return content;
            } else if (category === 'failed_approaches') {
                let content = `<strong>${item.approach || 'No approach'}</strong>`;
                if (item.lesson) content += `<br><small class="has-text-grey">Lesson: ${item.lesson}</small>`;
                return content;
            }
            return JSON.stringify(item).substring(0, 200);
        }

        async function doSearch() {
            const query = document.getElementById('search-input').value;
            if (!query) return;

            try {
                const response = await fetch(`/api/search?project=${project}&q=${encodeURIComponent(query)}`);
                const data = await response.json();

                const container = document.getElementById('search-results');
                container.innerHTML = '';

                let hasResults = false;
                const categoryStyles = {
                    decisions: 'context-decision',
                    corrections: 'context-correction',
                    insights: 'context-insight',
                    failed_approaches: 'context-failed'
                };

                for (const [category, results] of Object.entries(data)) {
                    if (results.length > 0) {
                        hasResults = true;
                        const header = document.createElement('h4');
                        header.className = 'title is-5 mt-4';
                        header.textContent = category.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
                        container.appendChild(header);

                        results.forEach(([item, score]) => {
                            const div = document.createElement('div');
                            div.className = `context-item box ${categoryStyles[category] || ''}`;
                            div.innerHTML = `
                                <span class="tag is-info">${score.toFixed(2)}</span>
                                ${formatSearchItem(item, category)}
                            `;
                            container.appendChild(div);
                        });
                    }
                }

                if (!hasResults) {
                    container.innerHTML = '<p class="has-text-grey">No results found</p>';
                }
            } catch (error) {
                console.error('Search failed:', error);
            }
        }

        document.getElementById('search-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') doSearch();
        });

        loadMetrics();
        updateLegend();
        initGraph();
        loadProactiveInsights();

        setInterval(loadMetrics, 30000);

        // Navbar burger toggle
        document.querySelector('.navbar-burger').addEventListener('click', () => {
            document.querySelector('.navbar-burger').classList.toggle('is-active');
            document.getElementById('navMenu').classList.toggle('is-active');
        });

        // Project selector
        async function loadProjects() {
            const select = document.getElementById('project-select');
            const response = await fetch('/api/projects');
            const projects = await response.json();
            // Auto-select first project if none specified
            const selectedProject = project || (projects.length > 0 ? projects[0] : '');
            if (!project && selectedProject) {
                window.location.href = `/?project=${encodeURIComponent(selectedProject)}`;
                return;
            }
            select.innerHTML = projects.map(p =>
                `<option value="${p}" ${p === selectedProject ? 'selected' : ''}>${p}</option>`
            ).join('');
            select.addEventListener('change', () => {
                window.location.href = `/?project=${encodeURIComponent(select.value)}`;
            });
        }
        loadProjects();

        // Developer Console WebSocket
        const filters = {hook: true, tool: true, neo4j: true, mcp: true, prompt: true};
        let ws;
        let reconnectDelay = 1000;

        function connectWs() {
            const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${location.host}/ws/logs`);
            const statusEl = document.getElementById('ws-status');

            ws.onopen = () => {
                statusEl.textContent = 'Connected';
                statusEl.className = 'tag is-success mr-2';
                reconnectDelay = 1000;
            };

            ws.onclose = () => {
                statusEl.textContent = 'Disconnected';
                statusEl.className = 'tag is-danger mr-2';
                setTimeout(connectWs, reconnectDelay);
                reconnectDelay = Math.min(reconnectDelay * 2, 10000);
            };

            ws.onerror = () => {
                statusEl.textContent = 'Error';
                statusEl.className = 'tag is-danger mr-2';
            };

            ws.onmessage = (e) => {
                try {
                    const log = JSON.parse(e.data);
                    const cat = log.cat || 'mcp';
                    if (!filters[cat]) return;

                    const div = document.createElement('div');
                    const categoryClass = {
                        'hook': 'has-text-info',
                        'tool': 'has-text-success',
                        'neo4j': 'has-text-warning',
                        'prompt': 'has-text-warning',
                    }[cat] || 'has-text-grey';
                    div.className = categoryClass;
                    if (log.error || log.level === 'ERROR') div.classList.add('has-text-danger');

                    let time = '';
                    if (log.ts) {
                        // Convert "2026-01-06 22:42:17,447" to ISO format
                        const isoTs = log.ts.replace(' ', 'T').replace(',', '.');
                        time = new Date(isoTs).toLocaleTimeString();
                    }
                    const event = log.event || log.raw || '';
                    const msg = log.msg ? `: ${log.msg}` : '';
                    const duration = log.duration_ms ? ` (${log.duration_ms}ms)` : '';
                    div.innerHTML = `<span class="has-text-grey">${time}</span> [${cat}] ${event}${msg}${duration}`;

                    const container = document.getElementById('console-log');
                    container.appendChild(div);
                    container.scrollTop = container.scrollHeight;

                    // Keep only last 500 entries
                    while (container.children.length > 500) {
                        container.removeChild(container.firstChild);
                    }
                } catch (err) {
                    console.error('Failed to parse log:', err);
                }
            };
        }

        function toggleFilter(cat, btn) {
            filters[cat] = !filters[cat];
            btn.classList.toggle('is-active');
        }

        function clearConsole() {
            document.getElementById('console-log').innerHTML = '';
        }

        connectWs();

        // Import drag-drop handling
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const importStatus = document.getElementById('import-status');

        dropZone.addEventListener('click', () => fileInput.click());

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('hover');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('hover');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('hover');
            const file = e.dataTransfer.files[0];
            if (file && file.name.endsWith('.zip')) {
                uploadFile(file);
            } else {
                showImportStatus('error', 'Please upload a .zip file');
            }
        });

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) uploadFile(file);
        });

        async function uploadFile(file) {
            showImportStatus('info', `Uploading ${file.name}...`);
            dropZone.style.opacity = '0.5';
            dropZone.style.pointerEvents = 'none';

            const formData = new FormData();
            formData.append('file', file);
            formData.append('project', project);

            try {
                showImportStatus('info', 'Processing conversations... (check console for progress)');
                const response = await fetch('/api/import', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();

                if (data.error) {
                    showImportStatus('error', data.error);
                } else {
                    showImportStatus('success',
                        `Processed: ${data.processed} files, ${data.detections} detections ` +
                        `(${data.files_skipped} skipped)`
                    );
                    loadMetrics();
                }
            } catch (err) {
                showImportStatus('error', 'Upload failed: ' + err.message);
            } finally {
                dropZone.style.opacity = '1';
                dropZone.style.pointerEvents = 'auto';
            }
        }

        function showImportStatus(type, message) {
            importStatus.classList.remove('hidden');
            const classes = {success: 'is-success', error: 'is-danger', info: 'is-info'};
            importStatus.className = `notification ${classes[type] || 'is-info'} mt-3`;
            importStatus.textContent = message;
        }

        async function clearDatabase() {
            if (!confirm(`Delete ALL data for project "${project}"? This cannot be undone.`)) {
                return;
            }
            try {
                const response = await fetch(`/api/clear?project=${encodeURIComponent(project)}`, {
                    method: 'DELETE'
                });
                const data = await response.json();
                if (data.error) {
                    alert('Error: ' + data.error);
                } else {
                    alert(`Deleted ${data.deleted} nodes`);
                    loadMetrics();
                }
            } catch (err) {
                alert('Failed to clear database: ' + err.message);
            }
        }
    </script>
</body>
</html>
