<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ccmemory Dashboard - {{ project }}</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .metric-card {
            text-align: center;
        }
        .metric-value {
            font-size: 2.5rem;
            font-weight: bold;
        }
        .metric-label {
            font-size: 0.9rem;
        }
        .context-item {
            margin-bottom: 1rem;
            padding: 1rem;
            border-radius: 4px;
        }
        .context-decision { border-left: 4px solid hsl(217, 71%, 53%); }
        .context-correction { border-left: 4px solid hsl(348, 100%, 61%); }
        .context-insight { border-left: 4px solid hsl(141, 53%, 53%); }
        .context-question { border-left: 4px solid hsl(48, 100%, 67%); }
        .context-failed { border-left: 4px solid hsl(344, 89%, 54%); }
        .coefficient-gauge {
            width: 200px;
            height: 100px;
            margin: 0 auto;
        }
        .console-log {
            height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.8rem;
            padding: 0.5rem;
        }
        .filter-btn.is-active {
            background-color: hsl(171, 100%, 41%);
            border-color: transparent;
            color: #fff;
        }
        .filter-btn:not(.is-active) {
            opacity: 0.5;
        }
        .drop-zone {
            border: 2px dashed;
            cursor: pointer;
        }
        .drop-zone.hover {
            background-color: hsl(217, 71%, 90%);
        }
        @media (prefers-color-scheme: dark) {
            .drop-zone.hover {
                background-color: hsl(217, 50%, 20%);
            }
        }
        .hidden { display: none; }
    </style>
</head>
<body>
    <nav class="navbar is-dark">
        <div class="navbar-brand">
            <span class="navbar-item is-size-4">
                <strong>ccmemory</strong>&nbsp;Dashboard
            </span>
        </div>
        <div class="navbar-menu">
            <div class="navbar-end">
                <div class="navbar-item">
                    <span class="tag is-info is-medium">{{ project }}</span>
                </div>
            </div>
        </div>
    </nav>

    <section class="section">
        <div class="container">
            <!-- Metrics Row -->
            <div class="columns is-multiline">
                <div class="column is-3">
                    <div class="box metric-card">
                        <p class="metric-value has-text-primary" id="coefficient">-</p>
                        <p class="metric-label">Cognitive Coefficient</p>
                    </div>
                </div>
                <div class="column is-3">
                    <div class="box metric-card">
                        <p class="metric-value has-text-info" id="decisions">-</p>
                        <p class="metric-label">Total Decisions</p>
                    </div>
                </div>
                <div class="column is-3">
                    <div class="box metric-card">
                        <p class="metric-value has-text-danger" id="corrections">-</p>
                        <p class="metric-label">Corrections</p>
                    </div>
                </div>
                <div class="column is-3">
                    <div class="box metric-card">
                        <p class="metric-value has-text-success" id="insights">-</p>
                        <p class="metric-label">Insights</p>
                    </div>
                </div>
            </div>

            <!-- Secondary Metrics -->
            <div class="columns is-multiline">
                <div class="column is-3">
                    <div class="box metric-card">
                        <p class="metric-value has-text-grey" id="sessions">-</p>
                        <p class="metric-label">Sessions</p>
                    </div>
                </div>
                <div class="column is-3">
                    <div class="box metric-card">
                        <p class="metric-value has-text-warning" id="failed">-</p>
                        <p class="metric-label">Failed Approaches</p>
                    </div>
                </div>
                <div class="column is-3">
                    <div class="box metric-card">
                        <p class="metric-value" id="reuse-rate">-</p>
                        <p class="metric-label">Decision Reuse Rate</p>
                    </div>
                </div>
                <div class="column is-3">
                    <div class="box metric-card">
                        <p class="metric-value" id="density">-</p>
                        <p class="metric-label">Graph Density</p>
                    </div>
                </div>
            </div>

            <!-- Import Conversations -->
            <div class="columns">
                <div class="column is-half">
                    <div class="box">
                        <h3 class="title is-5">Import Conversations</h3>
                        <div id="drop-zone" class="notification has-text-centered drop-zone">
                            <p>Drop a .zip file here or click to upload</p>
                            <p class="is-size-7 has-text-grey">Zip your ~/.claude/projects/*/&lt;uuid&gt;.jsonl files (max 50MB)</p>
                            <input type="file" id="file-input" accept=".zip" class="hidden">
                        </div>
                        <div id="import-status" class="mt-3 hidden"></div>
                    </div>
                </div>
                <div class="column is-half">
                    <div class="box">
                        <h3 class="title is-5">Database</h3>
                        <button class="button is-danger is-outlined" onclick="clearDatabase()">
                            Clear All Data for Project
                        </button>
                        <p class="is-size-7 has-text-grey mt-2">Deletes all sessions, decisions, corrections, insights for current project</p>
                    </div>
                </div>
            </div>

            <!-- Recent Context -->
            <div class="columns">
                <div class="column">
                    <h2 class="title is-4">Recent Context</h2>
                    <div id="recent-context">
                        <progress class="progress is-small is-primary" max="100">Loading...</progress>
                    </div>
                </div>
            </div>

            <!-- Search -->
            <div class="columns">
                <div class="column">
                    <h2 class="title is-4">Search</h2>
                    <div class="field has-addons">
                        <div class="control is-expanded">
                            <input class="input" type="text" id="search-input" placeholder="Search decisions, corrections, insights...">
                        </div>
                        <div class="control">
                            <button class="button is-primary" onclick="doSearch()">Search</button>
                        </div>
                    </div>
                    <div id="search-results"></div>
                </div>
            </div>

            <!-- Developer Console -->
            <div class="columns">
                <div class="column">
                    <div class="box">
                        <div class="level">
                            <div class="level-left">
                                <h2 class="title is-5 mb-0">Developer Console</h2>
                            </div>
                            <div class="level-right">
                                <span class="tag is-warning mr-2" id="ws-status">Connecting...</span>
                                <div class="buttons are-small">
                                    <button class="button filter-btn is-active" data-cat="hook" onclick="toggleFilter('hook', this)">Hooks</button>
                                    <button class="button filter-btn is-active" data-cat="tool" onclick="toggleFilter('tool', this)">Tools</button>
                                    <button class="button filter-btn is-active" data-cat="neo4j" onclick="toggleFilter('neo4j', this)">Neo4j</button>
                                    <button class="button is-small" onclick="clearConsole()">Clear</button>
                                </div>
                            </div>
                        </div>
                        <div class="console-log box" id="console-log"></div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <script>
        const project = "{{ project }}";

        async function loadMetrics() {
            try {
                const response = await fetch(`/api/metrics?project=${project}`);
                const data = await response.json();

                document.getElementById('coefficient').textContent = data.cognitive_coefficient.toFixed(2) + 'x';
                document.getElementById('decisions').textContent = data.total_decisions;
                document.getElementById('corrections').textContent = data.total_corrections;
                document.getElementById('insights').textContent = data.total_insights;
                document.getElementById('sessions').textContent = data.total_sessions;
                document.getElementById('failed').textContent = data.total_failed_approaches;
                document.getElementById('reuse-rate').textContent = (data.decision_reuse_rate * 100).toFixed(1) + '%';
                document.getElementById('density').textContent = data.graph_density.toFixed(2);
            } catch (error) {
                console.error('Failed to load metrics:', error);
            }
        }

        async function loadRecentContext() {
            try {
                const response = await fetch(`/api/recent?project=${project}&limit=15`);
                const data = await response.json();

                const container = document.getElementById('recent-context');
                container.innerHTML = '';

                if (data.length === 0) {
                    container.innerHTML = '<p class="has-text-grey">No context captured yet. Start a Claude Code session to begin.</p>';
                    return;
                }

                data.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'context-item box';

                    const nodeData = item.data;
                    let content = '';
                    let cssClass = '';

                    if (item.type === 'DECIDED') {
                        cssClass = 'context-decision';
                        content = `<strong>Decision:</strong> ${nodeData.description || 'No description'}`;
                        if (nodeData.rationale) {
                            content += `<br><small class="has-text-grey">Rationale: ${nodeData.rationale}</small>`;
                        }
                    } else if (item.type === 'CORRECTED') {
                        cssClass = 'context-correction';
                        content = `<strong>Correction:</strong> ${nodeData.right_belief || 'No belief recorded'}`;
                        if (nodeData.wrong_belief) {
                            content += `<br><small class="has-text-grey">Was: ${nodeData.wrong_belief}</small>`;
                        }
                    } else if (item.type === 'REALIZED') {
                        cssClass = 'context-insight';
                        content = `<strong>Insight:</strong> ${nodeData.summary || 'No summary'}`;
                        if (nodeData.category) {
                            content += `<br><span class="tag is-light">${nodeData.category}</span>`;
                        }
                    } else if (item.type === 'TRIED') {
                        cssClass = 'context-failed';
                        content = `<strong>Failed Approach:</strong> ${nodeData.approach || 'No approach recorded'}`;
                        if (nodeData.lesson) {
                            content += `<br><small class="has-text-grey">Lesson: ${nodeData.lesson}</small>`;
                        }
                    } else if (item.type === 'ASKED') {
                        cssClass = 'context-question';
                        content = `<strong>Q:</strong> ${nodeData.question || 'No question'}<br><strong>A:</strong> ${nodeData.answer || 'No answer'}`;
                    } else if (item.type === 'EXCEPTED') {
                        cssClass = 'context-decision';
                        content = `<strong>Exception:</strong> ${nodeData.justification || 'No justification'}`;
                        if (nodeData.rule_broken) {
                            content += `<br><small class="has-text-grey">Rule: ${nodeData.rule_broken}</small>`;
                        }
                    } else {
                        content = `<strong>${item.type}:</strong> ${JSON.stringify(nodeData).substring(0, 200)}`;
                    }

                    div.classList.add(cssClass);
                    div.innerHTML = content;
                    container.appendChild(div);
                });
            } catch (error) {
                console.error('Failed to load recent context:', error);
                document.getElementById('recent-context').innerHTML = '<p class="has-text-danger">Failed to load context</p>';
            }
        }

        function formatSearchItem(item, category) {
            if (category === 'decisions') {
                let content = `<strong>${item.description || 'No description'}</strong>`;
                if (item.rationale) content += `<br><small class="has-text-grey">Rationale: ${item.rationale}</small>`;
                if (item.status) content += `<br><span class="tag is-light">${item.status}</span>`;
                return content;
            } else if (category === 'corrections') {
                let content = `<strong>${item.right_belief || 'No belief'}</strong>`;
                if (item.wrong_belief) content += `<br><small class="has-text-grey">Was: ${item.wrong_belief}</small>`;
                return content;
            } else if (category === 'insights') {
                let content = `<strong>${item.summary || 'No summary'}</strong>`;
                if (item.category) content += `<br><span class="tag is-light">${item.category}</span>`;
                return content;
            } else if (category === 'failed_approaches') {
                let content = `<strong>${item.approach || 'No approach'}</strong>`;
                if (item.lesson) content += `<br><small class="has-text-grey">Lesson: ${item.lesson}</small>`;
                return content;
            }
            return JSON.stringify(item).substring(0, 200);
        }

        async function doSearch() {
            const query = document.getElementById('search-input').value;
            if (!query) return;

            try {
                const response = await fetch(`/api/search?project=${project}&q=${encodeURIComponent(query)}`);
                const data = await response.json();

                const container = document.getElementById('search-results');
                container.innerHTML = '';

                let hasResults = false;
                const categoryStyles = {
                    decisions: 'context-decision',
                    corrections: 'context-correction',
                    insights: 'context-insight',
                    failed_approaches: 'context-failed'
                };

                for (const [category, results] of Object.entries(data)) {
                    if (results.length > 0) {
                        hasResults = true;
                        const header = document.createElement('h4');
                        header.className = 'title is-5 mt-4';
                        header.textContent = category.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
                        container.appendChild(header);

                        results.forEach(([item, score]) => {
                            const div = document.createElement('div');
                            div.className = `context-item box ${categoryStyles[category] || ''}`;
                            div.innerHTML = `
                                <span class="tag is-info">${score.toFixed(2)}</span>
                                ${formatSearchItem(item, category)}
                            `;
                            container.appendChild(div);
                        });
                    }
                }

                if (!hasResults) {
                    container.innerHTML = '<p class="has-text-grey">No results found</p>';
                }
            } catch (error) {
                console.error('Search failed:', error);
            }
        }

        document.getElementById('search-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') doSearch();
        });

        loadMetrics();
        loadRecentContext();

        setInterval(loadMetrics, 30000);

        // Developer Console WebSocket
        const filters = {hook: true, tool: true, neo4j: true};
        let ws;
        let reconnectDelay = 1000;

        function connectWs() {
            const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${location.host}/ws/logs`);
            const statusEl = document.getElementById('ws-status');

            ws.onopen = () => {
                statusEl.textContent = 'Connected';
                statusEl.className = 'tag is-success mr-2';
                reconnectDelay = 1000;
            };

            ws.onclose = () => {
                statusEl.textContent = 'Disconnected';
                statusEl.className = 'tag is-danger mr-2';
                setTimeout(connectWs, reconnectDelay);
                reconnectDelay = Math.min(reconnectDelay * 2, 10000);
            };

            ws.onerror = () => {
                statusEl.textContent = 'Error';
                statusEl.className = 'tag is-danger mr-2';
            };

            ws.onmessage = (e) => {
                try {
                    const log = JSON.parse(e.data);
                    const cat = log.cat || 'mcp';
                    if (!filters[cat]) return;

                    const div = document.createElement('div');
                    const categoryClass = {
                        'hook': 'has-text-info',
                        'tool': 'has-text-success',
                        'neo4j': 'has-text-warning',
                    }[cat] || 'has-text-grey';
                    div.className = categoryClass;
                    if (log.error || log.level === 'ERROR') div.classList.add('has-text-danger');

                    let time = '';
                    if (log.ts) {
                        // Convert "2026-01-06 22:42:17,447" to ISO format
                        const isoTs = log.ts.replace(' ', 'T').replace(',', '.');
                        time = new Date(isoTs).toLocaleTimeString();
                    }
                    const event = log.event || log.raw || '';
                    const msg = log.msg ? `: ${log.msg}` : '';
                    const duration = log.duration_ms ? ` (${log.duration_ms}ms)` : '';
                    div.innerHTML = `<span class="has-text-grey">${time}</span> [${cat}] ${event}${msg}${duration}`;

                    const container = document.getElementById('console-log');
                    container.appendChild(div);
                    container.scrollTop = container.scrollHeight;

                    // Keep only last 500 entries
                    while (container.children.length > 500) {
                        container.removeChild(container.firstChild);
                    }
                } catch (err) {
                    console.error('Failed to parse log:', err);
                }
            };
        }

        function toggleFilter(cat, btn) {
            filters[cat] = !filters[cat];
            btn.classList.toggle('is-active');
        }

        function clearConsole() {
            document.getElementById('console-log').innerHTML = '';
        }

        connectWs();

        // Import drag-drop handling
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const importStatus = document.getElementById('import-status');

        dropZone.addEventListener('click', () => fileInput.click());

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('hover');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('hover');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('hover');
            const file = e.dataTransfer.files[0];
            if (file && file.name.endsWith('.zip')) {
                uploadFile(file);
            } else {
                showImportStatus('error', 'Please upload a .zip file');
            }
        });

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) uploadFile(file);
        });

        async function uploadFile(file) {
            showImportStatus('info', `Uploading ${file.name}...`);
            dropZone.style.opacity = '0.5';
            dropZone.style.pointerEvents = 'none';

            const formData = new FormData();
            formData.append('file', file);
            formData.append('project', project);

            try {
                showImportStatus('info', 'Processing conversations... (check console for progress)');
                const response = await fetch('/api/import', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();

                if (data.error) {
                    showImportStatus('error', data.error);
                } else {
                    showImportStatus('success',
                        `Processed: ${data.processed} files, ${data.detections} detections ` +
                        `(${data.files_skipped} skipped)`
                    );
                    loadMetrics();
                    loadRecentContext();
                }
            } catch (err) {
                showImportStatus('error', 'Upload failed: ' + err.message);
            } finally {
                dropZone.style.opacity = '1';
                dropZone.style.pointerEvents = 'auto';
            }
        }

        function showImportStatus(type, message) {
            importStatus.classList.remove('hidden');
            const classes = {success: 'is-success', error: 'is-danger', info: 'is-info'};
            importStatus.className = `notification ${classes[type] || 'is-info'} mt-3`;
            importStatus.textContent = message;
        }

        async function clearDatabase() {
            if (!confirm(`Delete ALL data for project "${project}"? This cannot be undone.`)) {
                return;
            }
            try {
                const response = await fetch(`/api/clear?project=${encodeURIComponent(project)}`, {
                    method: 'DELETE'
                });
                const data = await response.json();
                if (data.error) {
                    alert('Error: ' + data.error);
                } else {
                    alert(`Deleted ${data.deleted} nodes`);
                    loadMetrics();
                    loadRecentContext();
                }
            } catch (err) {
                alert('Failed to clear database: ' + err.message);
            }
        }
    </script>
</body>
</html>
